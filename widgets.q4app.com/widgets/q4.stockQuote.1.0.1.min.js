/*
Widget:   q4.stockQuote
Version:  1.0.1
Compiled: 2017-05-23
*/
!function(a){a.widget("q4.stockQuote",{options:{items:1,exchange:"",symbol:"",useFullStockQuote:!0,useXignite:!1,usePublic:!1,apiKey:"",changeCls:["StockPriceDown","StockPriceUp"],dateFormat:"M d, yy",url:"",stockTpl:'{{#.}}<div class="StockTableItem"><p class="{{uod}}"><span>Price</span><a>{{tradePrice}}</a></p><p><span>Change</span><a>{{change}}</a></p></div><div class="StockTableItem"><p><span>Volume</span><a>{{volume}}</a></p><p><span>% Change</span><a>{{percChange}}%</a></p></div><div class="StockTableItem"><p><span>Intraday High</span><a>{{high}}</a></p><p><span>52 Week High</span><a>{{high52}}</a></p></div><div class="StockTableItem"><p><span>Intraday Low</span><a>{{low}}</a></p><p><span>52 Week Low</span><a>{{low52}}</a></p></div><div class="StockTableItem"><p><span>Today\'s Open</span><a>{{open}}</a></p><p><span>Previous Close</span><a>{{previousClose}}</a></p></div><div class="StockTableItem"><p><span>EPS</span><a>{{eps}}</a></p><p><span>Market Cap</span><a>{{marketCap}}</a></p></div><div class="StockTableText"><span>{{tradeDate}}</span> <span>{{tradeTime}}</span> Pricing delayed 20 minutes</div>{{/.}}',beforeRender:function(a,b){},complete:function(a){}},exchangeCodes:{NASDAQ:"XNAS",NASD:"XNAS",NYSE:"XNYS",TSE:"XTSE",TSX:"XTSE","TSX-V":"XTSX"},_create:function(){var a=this,b=a.options;b.symbol.length&&b.exchange.length?a._getStockQuote():a._getStockIndice()},_buildParams:function(){return{serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),StartIndex:0,RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature(),ItemCount:this.options.items}}},_getStockIndice:function(){var b,c=this,d=c.options;b=d.usePublic?c._getData(d.url+"/feed/Lookup.svc/GetLookupList",{apiKey:d.apiKey,lookupType:"indices"}):c._getData("/Services/LookupService.svc/GetLookupList",a.extend(c._buildParams(),{lookupType:"indices"})),b.fail(function(a,b,c){console.error("Error fetching indice: "+c)}).done(function(a){if(a.GetLookupListResult.length){var b=a.GetLookupListResult[0].Value.split(":");d.exchange=b[0],d.symbol=b[1],c._getStockQuote()}else d.usePublic?d.url.length&&d.apiKey.length?console.log("There are no active indices on "+d.url):console.log("Check that you have configured a valid url and apiKey"):console.log("There are no active indices")})},_addCommas:function(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var b=/(\d+)(\d{3})/;b.test(x1);)x1=x1.replace(b,"$1,$2");return x1+x2},_convertTime:function(a){var b=a.split(":"),c=b[0],d="AM";return c>=12&&(d="PM",c-=12),0===c&&(c=12),c+":"+b[1]+" "+d},_getData:function(b,c){return this.options.usePublic?a.ajax({type:"GET",url:b,data:c,contentType:"application/json; charset=utf-8",dataType:"jsonp"}):a.ajax({type:"POST",url:b,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},_getStockQuote:function(){var b,c=this,d=c.options,e=void 0!==c.exchangeCodes[d.exchange]?c.exchangeCodes[d.exchange]:d.exchange,f=d.useFullStockQuote?"GetFullStockQuoteList":"GetStockQuoteList";b=d.usePublic?c._getData(d.url+"/feed/StockQuote.svc/"+f,{apiKey:d.apiKey,exchange:d.useXignite?e:d.exchange,symbol:d.symbol,pageSize:d.items}):c._getData("/services/StockQuoteService.svc/"+f,a.extend(c._buildParams(),{exchange:d.useXignite?e:d.exchange,symbol:d.symbol})),b.fail(function(a,b,c){console.error("Error fetching stock data: "+c)}).done(function(a){a[f+"Result"].length?(c.element.html(c._normalizeData(a[f+"Result"])),c._trigger("complete")):console.log("There are no results for "+d.exchange+":"+d.symbol)})},_normalizeData:function(b){var c=this,d=c.options,e={items:[]};return a.each(b,function(b,f){var g={change:f.Change.toFixed(2),high:f.High.toFixed(2),high52:f.High52.toFixed(2),low:f.Low.toFixed(2),low52:f.Low52.toFixed(2),open:f.Open.toFixed(2),percChange:f.PercChange,previousClose:f.PreviousClose.toFixed(2),tradeDate:a.datepicker.formatDate(d.dateFormat,new Date(f.TradeDate)),tradeTime:c._convertTime(f.TradeDate.split(" ").pop()),tradePrice:f.TradePrice.toFixed(2),uod:"-"==f.Change.toString().charAt(0)?d.changeCls[0]:d.changeCls[1],volume:c._addCommas(f.Volume)};d.useFullStockQuote&&a.extend(g,{companyName:f.CompanyName,divAmount:f.DivAmount,divFrequency:f.DivFrequency,divYield:f.DivYield,eps:f.EPS.toFixed(2),exDivDate:f.ExDivDate,exchange:f.Exchange,marketCap:f.MarketCap,peRatio:f.PeRatio,shareOut:f.ShareOut,shareTraded:f.ShareTraded,symbol:f.Symbol,tickerSymbol:f.TickerSymbol}),e.items.push(g)}),c._trigger("beforeRender",null,e),Mustache.render(c.options.stockTpl,e.items)},destroy:function(){this.element.html("")},_setOption:function(a,b){this._superApply(arguments)}})}(jQuery);