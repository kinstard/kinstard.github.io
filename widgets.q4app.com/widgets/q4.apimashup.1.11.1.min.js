/*
Widget:   q4.apimashup
Version:  1.11.1
Compiled: 2017-04-05
*/
!function(a){a.widget("q4.apiMashup",{options:{contentSources:{},startSource:null,url:"",limit:0,skip:0,fetchAllYears:!1,showAllYears:!1,allYearsText:"All",startYear:null,forceStartYear:!1,showFuture:!0,showPast:!0,tags:[],titleLength:0,bodyLength:0,shortBodyLength:0,shortTypes:{"Annual Report":"Annual","Supplemental Report":"Supplemental","First Quarter":"Q1","Second Quarter":"Q2","Third Quarter":"Q3","Fourth Quarter":"Q4"},dateFormat:"mm/dd/yy",useMoment:!1,sortAscending:!1,years:[],minYear:null,maxYear:null,minDate:null,maxDate:null,defaultThumb:"",template:"",append:!0,cssClass:null,loadingClass:null,loadingMessage:"Loading...",yearContainer:null,yearTemplate:null,yearTrigger:null,yearSelect:null,contentSourceContainer:null,contentSourceTemplate:null,contentSourceTrigger:null,contentSourceSelect:null,tagSelect:null,activeClass:"active",itemContainer:null,itemTemplate:"",itemLoadingClass:null,itemLoadingMessage:null,itemNotFoundMessage:"No items found.",onYearChange:function(a,b){},onTagChange:function(a,b){},onContentSourceChange:function(a,b){},beforeRender:function(a,b){},beforeRenderItems:function(a,b){},itemsComplete:function(a){},complete:function(a){}},$widget:null,contentSourceIDs:[],years:null,currentSourceIDs:[],currentYear:-1,currentTags:[],_setOption:function(a,b){this._super(a,b),this._normalizeOptions()},_convertToArray:function(b){return"string"==typeof b&&(b=a.trim(b).split(/[\s,|]+/)),a.isArray(b)?b:[]},_convertToDate:function(a){var b=new Date(a);return"Invalid Date"==b.toString()?null:b},_normalizeOptions:function(){var a=this.options;a.url=a.url.replace(/\/$/,""),a.years=this._convertToArray(a.years).sort(function(a,b){return b-a}),a.tags=this._convertToArray(a.tags),"string"==typeof a.startYear&&a.startYear.length&&(a.startYear=parseInt(a.startYear)),a.minDate=a.minDate?this._convertToDate(a.minDate):null,a.maxDate=a.maxDate?this._convertToDate(a.maxDate):null,!a.startSource||a.startSource in a.contentSources||(a.startSource=null),null===a.itemLoadingClass&&(a.itemLoadingClass=a.loadingClass),null===a.itemLoadingMessage&&(a.itemLoadingMessage=a.loadingMessage)},_init:function(){var b=this,c=this.options,d=this.element;this._normalizeOptions(),this.$widget=c.append?a("<div>").appendTo(d):d,c.cssClass&&this.$widget.addClass(c.cssClass),c.loadingClass&&this.$widget.addClass(c.loadingClass),this.$widget.html(c.loadingMessage||""),this.contentSourceIDs=a.map(c.contentSources,function(a,b){return b}),this.currentSourceIDs=c.startSource in this.contentSourceIDs?[c.startSource]:this.contentSourceIDs,this.currentTags=c.tags;var e=a.map(this.currentSourceIDs,function(a){return b._getYears(a)});a.when.apply(null,e).done(function(){var d=[];a.each(arguments,function(b,c){a.each(c.years,function(b,c){a.inArray(c,d)==-1&&d.push(c)})}),b.years=b._filterYears(d),b.currentYear=b._getCurrentYear(b.years);var e=a.map(arguments,function(a,c){return null!==a.items?a.items:b._fetchSourceItems(b.currentSourceIDs[c],b.currentYear)});a.when.apply(null,e).done(function(){var a=Array.prototype.concat.apply([],arguments);a.sort(function(a,b){return(b.dateObj-a.dateObj)*(c.sortAscending?-1:1)}),c.limit&&(a=a.slice(0,c.limit)),b._renderWidget(a)})})},_getYears:function(b){var c=this.options,d=a.Deferred();return c.fetchAllYears&&!c.limit||c.contentSources[b].limit?this._fetchSourceItems(b,-1).done(function(b){var c=[];a.each(b,function(b,d){a.inArray(d.year,c)==-1&&c.push(d.year)}),d.resolve({years:c,items:b})}):this._fetchYears(b).done(function(a){d.resolve({years:a,items:null})}),d},_filterYears:function(b){var c=this.options;return b=a.grep(b,function(b){return(!c.minYear||b>=c.minYear)&&(!c.maxYear||b<=c.maxYear)&&(!c.years.length||a.inArray(b,c.years)>-1)}),c.forceStartYear&&a.inArray(c.startYear,b)==-1&&b.push(c.startYear),b.sort(function(a,b){return b-a}),b},_getCurrentYear:function(b){var c=this.options;if(b.length){if(a.inArray(c.startYear,b)>-1)return c.startYear;if(!c.showAllYears)return b[0]}return-1},_buildParams:function(){return{serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature()}}},_callApi:function(b,c){var d=this.options;return a.ajax({type:"POST",url:d.url+b,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},_fetchYears:function(b){var c=this.options,d=c.contentSources[b],e=this.contentTypes[d.type],f=a.extend({},this.options,e.options,d),g=a.Deferred(),h=a.grep(this.currentTags||[],function(a){return a.length>0});return this._callApi(e.yearsUrl,a.extend(!0,this._buildParams(),e.buildParams.call(this,f),{serviceDto:{TagList:a.merge(a.merge([],h),d.tags||[])}})).done(function(a){g.resolve(a[e.yearsResultField])}),g},_fetchAllItems:function(b,c){var d=this,e=this.options,f=a.Deferred(),g=a.map(b,function(a){return d._fetchSourceItems(a,c)});return a.when.apply(null,g).done(function(){var a=Array.prototype.concat.apply([],arguments);a.sort(function(a,b){return(b.dateObj-a.dateObj)*(e.sortAscending?-1:1)}),e.limit&&(a=a.slice(0,e.limit)),f.resolve(a)}),f},_fetchSourceItems:function(b,c){var d=this,e=this.options,f=e.contentSources[b],g=this.contentTypes[f.type],h=a.extend({},this.options,g.options,f),i=a.Deferred(),j=a.grep(this.currentTags||[],function(a){return a.length>0});return this._callApi(g.itemsUrl,a.extend(!0,this._buildParams(),g.buildParams.call(this,h),{serviceDto:{ItemCount:f.limit||-1,StartIndex:e.skip,TagList:a.merge(a.merge([],j),f.tags||[]),IncludeTags:!0},year:e.fetchAllYears?-1:c})).done(function(c){var f=a.map(c[g.itemsResultField],function(a){var c=g.parseItem.call(d,h,a);return c.contentSourceID=b,c});f=a.grep(f,function(a){return(!e.minDate||a.dateObj>=e.minDate)&&(!e.maxDate||a.dateObj<=e.maxDate)}),i.resolve(f)}),i},_truncate:function(a,b){return a?!b||a.length<=b?a:a.substring(0,b)+"...":""},_formatDate:function(b){var c=this.options,d=new Date(b),e=c.useMoment&&"undefined"!=typeof moment;if("string"==typeof c.dateFormat)return e?moment(d).format(c.dateFormat):a.datepicker.formatDate(c.dateFormat,d);if("object"==typeof c.dateFormat){var f={};for(name in c.dateFormat)f[name]=e?moment(d).format(c.dateFormat[name]):a.datepicker.formatDate(c.dateFormat[name],d);return f}},_buildTemplateData:function(b){var c=this,d=this.options,e={},f={},g={items:[],years:[],yearsWithItems:[],contentSources:[],sourcesWithItems:[]};return a.each(b,function(b,d){return a.inArray(d.year,c.years)==-1||(d.year in e||(e[d.year]=[]),d.contentSourceID in f||(f[d.contentSourceID]=[]),g.items.push(d),e[d.year].push(d),void f[d.contentSourceID].push(d))}),d.showAllYears&&this.years.length&&g.years.push({year:d.allYearsText,value:-1,items:g.items}),a.each(this.years,function(a,b){g.years.push({year:b,value:b,items:e[b]||[]}),b in e&&g.yearsWithItems.push({year:b,value:b,items:e[b]})}),a.each(d.contentSources,function(a,b){g.contentSources.push({id:a,label:b.label,items:f[a]||[]}),a in f&&g.sourcesWithItems.push({id:a,label:b.label,items:f[a]})}),g},_renderItems:function(b){var c=this.options,d=this.element,e=a(c.itemContainer,d);this._trigger("beforeRenderItems",null,{items:b}),c.itemLoadingClass&&e.removeClass(c.itemLoadingClass),b.length?(e.empty(),a.each(b,function(a,b){var d=c.contentSources[b.contentSourceID].template||c.itemTemplate;e.append(Mustache.render(d,b))})):e.html(c.itemNotFoundMessage||""),this._trigger("itemsComplete")},_renderWidget:function(b){var c=this,d=this.options,e=this.element,f=this._buildTemplateData(b),g=[];a.each(f.years,function(a,b){b.value==c.currentYear&&(b.active=!0,g=b.items)}),this._trigger("beforeRender",null,f),d.loadingClass&&this.$widget.removeClass(d.loadingClass),this.$widget.html(Mustache.render(d.template,f)),d.itemContainer&&this._renderItems(g),d.yearContainer&&d.yearTemplate&&(a(d.yearContainer,e).empty(),a.each(f.years,function(b,c){a(d.yearContainer,e).append(Mustache.render(d.yearTemplate,c))})),d.yearTrigger&&a(d.yearTrigger,e).each(function(b){var e=f.years[b].value;a(this).data("year",e),a(this).click(function(b){a(this).hasClass(d.activeClass)||c.setYear(e,b)})}),d.yearSelect&&a(d.yearSelect,e).change(function(b){c.setYear(a(this).val(),b)}),d.contentSourceContainer&&d.contentSourceTemplate&&(a(d.contentSourceContainer,e).empty(),a.each(f.contentSources,function(b,c){a(d.contentSourceContainer,e).append(Mustache.render(d.contentSourceTemplate,c))})),d.contentSourceTrigger&&a(d.contentSourceTrigger,e).each(function(b){var e=f.contentSources[b].id;a(this).data("id",e),a(this).click(function(b){a(this).hasClass(d.activeClass)||c.setContentSource(e,b)})}),d.contentSourceSelect&&a(d.contentSourceSelect,e).change(function(b){c.setContentSource(a(this).val(),b)}),this._updateYearControls(this.currentYear),this._trigger("complete")},_updateYearControls:function(b){var c=this.options,d=this.element;c.yearTrigger&&a(c.yearTrigger,d).each(function(){a(this).toggleClass(c.activeClass,a(this).data("year")==b)}),c.yearSelect&&a(c.yearSelect,d).val(b)},reloadItems:function(){var b=this,c=this.options,d=this.element;if(c.itemContainer){var e=a(c.itemContainer,d);c.itemLoadingClass&&e.addClass(c.itemLoadingClass),e.html(c.itemLoadingMessage||"")}else c.loadingClass&&this.$widget.addClass(c.loadingClass),this.$widget.html(c.loadingMessage||"");this._fetchAllItems(this.currentSourceIDs,this.currentYear).done(function(a){c.itemContainer?b._renderItems(a):b._renderWidget(a)})},setContentSource:function(a,b){var c=a.length?[a]:this.contentSourceIDs;this._trigger("onContentSourceChange",b,{contentSources:c}),b&&b.isDefaultPrevented()||(this.currentSourceIDs=c,this.reloadItems())},setYear:function(b,c){var d=this.options,e=parseInt(b);a.inArray(e,this.years)==-1&&(e=d.showAllYears?-1:this.years[0]),this._trigger("onYearChange",c,{year:e}),c&&c.isDefaultPrevented()||(this.currentYear=e,this._updateYearControls(this.currentYear),this.reloadItems())},setTags:function(a,b){a=this._convertToArray(a),this._trigger("onTagChange",b,{tags:a}),b&&b.isDefaultPrevented()||(this.currentTags=a,this.reloadItems())},contentTypes:{downloads:{options:{downloadType:"",tags:[],template:""},itemsUrl:"/Services/ContentAssetService.svc/GetContentAssetList",yearsUrl:"/Services/ContentAssetService.svc/GetContentAssetYearList",itemsResultField:"GetContentAssetListResult",yearsResultField:"GetContentAssetYearListResult",buildParams:function(a){return{assetType:a.downloadType}},parseItem:function(a,b){return{title:this._truncate(b.Title,a.titleLength),url:b.FilePath,dateObj:new Date(b.ContentAssetDate),year:new Date(b.ContentAssetDate).getFullYear(),date:this._formatDate(b.ContentAssetDate),type:b.Type,fileType:b.FileType,size:b.FileSize,icon:b.IconPath,thumb:b.ThumbnailPath,tags:b.TagsList,description:this._truncate(b.Description,a.bodyLength)}}},events:{options:{tags:[],template:""},itemsUrl:"/Services/EventService.svc/GetEventList",yearsUrl:"/Services/EventService.svc/GetEventYearList",itemsResultField:"GetEventListResult",yearsResultField:"GetEventYearListResult",buildParams:function(a){return{eventSelection:a.showFuture&&!a.showPast?1:a.showPast&&!a.showFuture?0:3,includeFinancialReports:!0,includePresentations:!0,includePressReleases:!0,sortOperator:a.sortAscending?0:1}},parseItem:function(b,c){var d=this,e=new Date,f=new Date(c.StartDate),g=new Date(c.EndDate);return{title:this._truncate(c.Title,b.titleLength),url:c.LinkToDetailPage,id:c.EventId,dateObj:f,year:f.getFullYear(),date:this._formatDate(c.StartDate),endDate:this._formatDate(c.EndDate),timeZone:c.TimeZone,isFuture:f>e,isPast:g<e,location:c.Location,tags:c.TagsList,body:this._truncate(c.Body,b.bodyLength),webcast:c.WebCastLink,docs:a.map(c.Attachments,function(a){return{title:a.Title,url:a.Url,type:a.Type,extension:a.Extension,size:a.Size}}),speakers:a.map(c.EventSpeaker,function(a){return{name:a.SpeakerName,position:a.SpeakerPosition}}),financialReports:a.map(c.EventFinancialReport,function(a){return d.contentTypes.financials.parseItem.call(d,b,a)}),pressReleases:a.map(c.EventPressRelease,function(a){return d.contentTypes.news.parseItem.call(d,b,a)}),presentations:a.map(c.EventPresentation,function(a){return d.contentTypes.presentations.parseItem.call(d,b,a)})}}},financials:{options:{reportTypes:[],docCategories:[],tags:[],template:""},itemsUrl:"/Services/FinancialReportService.svc/GetFinancialReportList",yearsUrl:"/Services/FinancialReportService.svc/GetFinancialReportYearList",itemsResultField:"GetFinancialReportListResult",yearsResultField:"GetFinancialReportYearListResult",buildParams:function(a){return{reportSubType:a.reportTypes,reportSubTypeList:a.reportTypes}},parseItem:function(b,c){var d=this,e=a.map(c.Documents,function(a){return{docCategory:a.DocumentCategory,docSize:a.DocumentFileSize,docThumb:a.ThumbnailPath,docTitle:d._truncate(a.DocumentTitle,b.titleLength),docType:a.DocumentFileType,docUrl:a.DocumentPath}});return a.isArray(b.docCategories)&&b.docCategories.length&&(e=a.grep(e,function(c){return a.inArray(c.docCategory,b.docCategories)>-1})),{coverUrl:c.CoverImagePath,title:c.ReportTitle,fiscalYear:c.ReportYear,dateObj:new Date(c.ReportDate),year:new Date(c.ReportDate).getFullYear(),date:this._formatDate(c.ReportDate),tags:c.TagsList,type:c.ReportSubType,shortType:b.shortTypes[c.ReportSubType],docs:e}}},presentations:{options:{tags:[],template:""},itemsUrl:"/Services/PresentationService.svc/GetPresentationList",yearsUrl:"/Services/PresentationService.svc/GetPresentationYearList",itemsResultField:"GetPresentationListResult",yearsResultField:"GetPresentationYearListResult",buildParams:function(a){return{presentationSelection:a.showFuture&&!a.showPast?0:a.showPast&&!a.showFuture?1:3}},parseItem:function(a,b){return{title:this._truncate(b.Title,a.titleLength),url:b.LinkToDetailPage,dateObj:new Date(b.PresentationDate),year:new Date(b.PresentationDate).getFullYear(),date:this._formatDate(b.PresentationDate),tags:b.TagsList,body:this._truncate(b.Body,a.bodyLength),docUrl:b.DocumentPath,docSize:b.DocumentFileSize,docType:b.DocumentFileType,thumb:b.ThumbnailPath}}},news:{options:{category:"00000000-0000-0000-0000-000000000000",loadBody:!0,loadShortBody:!0,tags:[],template:""},itemsUrl:"/Services/PressReleaseService.svc/GetPressReleaseList",yearsUrl:"/Services/PressReleaseService.svc/GetPressReleaseYearList",itemsResultField:"GetPressReleaseListResult",yearsResultField:"GetPressReleaseYearListResult",buildParams:function(a){return{pressReleaseSelection:a.showFuture&&!a.showPast?0:a.showPast&&!a.showFuture?1:3,pressReleaseBodyType:a.loadShortBody?a.loadBody?1:3:a.loadBody?2:0,pressReleaseCategoryWorkflowId:a.category}},parseItem:function(a,b){return{title:this._truncate(b.Headline,a.titleLength),url:b.LinkToDetailPage,dateObj:new Date(b.PressReleaseDate),year:new Date(b.PressReleaseDate).getFullYear(),date:this._formatDate(b.PressReleaseDate),tags:b.TagsList,body:this._truncate(b.Body,a.bodyLength),shortBody:this._truncate(b.ShortBody,a.shortBodyLength),docUrl:b.DocumentPath,docSize:b.DocumentFileSize,docType:b.DocumentFileType,thumb:b.ThumbnailPath||a.defaultThumb}}},sec:{options:{exchange:"",symbol:"",excludeNoDocuments:!1,filingTypes:[],template:""},itemsUrl:"/Services/SECFilingService.svc/GetEdgarFilingList",yearsUrl:"/Services/SECFilingService.svc/GetEdgarFilingYearList",itemsResultField:"GetEdgarFilingListResult",yearsResultField:"GetEdgarFilingYearListResult",buildParams:function(a){return{exchange:a.exchange,symbol:a.symbol,formGroupIdList:a.filingTypes.join(",")}},parseItem:function(b,c){return{id:c.FilingId,description:this._truncate(c.FilingDescription,b.titleLength),url:c.LinkToDetailPage,dateObj:new Date(c.FilingDate),year:new Date(c.FilingDate).getFullYear(),date:this._formatDate(c.FilingDate),agent:c.FilingAgentName,person:c.ReportPersonName,type:c.FilingTypeMnemonic,docs:a.map(c.DocumentList,function(a){return{docType:a.DocumentType,docUrl:a.Url}})}}}}})}(jQuery);